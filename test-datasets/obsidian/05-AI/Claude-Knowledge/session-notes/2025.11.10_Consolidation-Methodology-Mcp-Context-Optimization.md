---
type: claude-knowledge
source: aiprojects
source_path: "knowledge/notes/consolidation-methodology-mcp-context-optimization.md"
source_category: "session-knowledge"
synced: 2026-02-17
title: "Context Consolidation Methodology - MCP Optimization Example"
tags:
  - claude-knowledge
  - session-knowledge
---

# Context Consolidation Methodology - MCP Optimization Example

**Date**: 2025-11-10
**Type**: Context Optimization
**Target**: MCP tool definitions consuming 36.5% (73k tokens) of context window
**Result**: Reduced to ~30% (~12k tokens saved, 32% reduction in key files)

## Overview

This document captures the methodology used to consolidate MCP context, which can be applied to other consolidation tasks in the project.

## Problem Identification

### Initial State
- `/context` command showed MCP tools at 73k tokens (36.5% of 200k context)
- 114 MCP tools loaded across 7 servers
- User concern: "Too much context for tools"

### Analysis Process
1. **Read context breakdown**: Used `/context` to see token distribution
2. **Check documentation**: Read `.claude/context/integrations/mcp-servers.md` (294 lines)
3. **List active servers**: Ran `claude mcp list` to see actual status
4. **Identify culprits**:
   - mcp-gateway: 45 tools (39% of all MCP tools)
   - Duplicate memory tools: standalone (7) + gateway (9)
   - Detailed workflows embedded in always-loaded context

## Strategy Development

### Three-Pronged Approach

**1. Remove Duplicates**
- Identified: Standalone `memory` server duplicates `mcp-gateway` memory
- Decision: Keep gateway version (needed for n8n integration)
- Action: Remove standalone via `claude mcp remove memory`

**2. Extract Detailed Content → On-Demand Loading**
- Identified: 150+ lines of Playwright workflows in mcp-servers.md
- Pattern: High-level overview (always loaded) + detailed docs (load when needed)
- Structure:
  ```
  .claude/context/integrations/mcp-servers.md (slim, always loaded)
  └─ References → knowledge/reference/mcp/playwright-workflows.md (on-demand)
  ```

**3. Update References Across Project**
- Files to update: CLAUDE.md, system-state.md, mcp-servers.md
- Ensure consistent messaging about on-demand pattern
- Update server counts and status

## Execution Steps

### Phase 1: Remove Duplicates
1. ✅ Verified memory functionality via gateway: `mcp__memory__read_graph`
2. ✅ Removed standalone: `claude mcp remove memory`
3. ✅ Noted change for documentation

### Phase 2: Extract & Consolidate Content
1. ✅ Created new on-demand doc: `knowledge/reference/mcp/playwright-workflows.md`
   - Extracted all 21 Playwright tool descriptions
   - Moved workflow patterns (web service checks, form testing, visual regression)
   - Moved error handling and best practices
   - Added integration examples
   - Result: Comprehensive 500+ line reference guide

2. ✅ Slimmed source doc: `.claude/context/integrations/mcp-servers.md`
   - Removed detailed Playwright content (150+ lines)
   - Replaced with "Browser Automation Quick Reference" (15 lines)
   - Added reference link to on-demand doc
   - Updated MCP Gateway description to reference new doc
   - Result: 294 → 199 lines (32% reduction)

### Phase 3: Update Project Documentation
1. ✅ Updated `CLAUDE.md`:
   - Changed MCP section to emphasize on-demand pattern
   - Added "On-Demand Documentation" list with all MCP reference docs
   - Updated server counts (7 active, 1 inactive)
   - Removed detailed server descriptions (moved to on-demand)

2. ✅ Updated `system-state.md`:
   - Updated MCP Integration section with correct tool counts
   - Moved postgres-n8n from "Critical" to "Low Priority" (fix later)
   - Added Recent Changes entry for 2025-11-10
   - Documented consolidation work

### Phase 4: Validation & Testing
1. ✅ Tested memory graph functionality via gateway
2. ✅ Verified git status showed expected file changes
3. ✅ Reviewed diff stats: 65 insertions, 148 deletions (net -83 lines)

### Phase 5: Commit & Document
1. ✅ Staged all changes
2. ✅ Created descriptive commit message with:
   - Clear title summarizing changes
   - Bullet points for each major change
   - Metrics (token reduction, line counts)
   - Server status summary
3. ✅ Pushed to GitHub

## Key Patterns & Principles

### 1. Always-Loaded vs On-Demand Pattern

**Always-Loaded Context** (minimize):
- High-level overviews
- Quick reference tables
- "When to use X" guidance
- Links to detailed docs

**On-Demand Context** (detailed):
- Complete tool references
- Detailed workflows
- Error handling guides
- Integration examples

### 2. File Organization Strategy

```
.claude/context/           # Always loaded (slim)
├─ integrations/
│  └─ mcp-servers.md      # High-level MCP overview
└─ ...

knowledge/reference/       # Load when needed (detailed)
├─ mcp/
│  ├─ playwright-workflows.md    # Browser automation (500+ lines)
│  ├─ docker-mcp.md              # Container patterns
│  └─ ...
```

### 3. Reference Update Cascade

When consolidating, update references in this order:
1. **Source files**: Create new on-demand docs, slim existing files
2. **CLAUDE.md**: Update top-level project instructions
3. **system-state.md**: Update infrastructure status
4. **Related context files**: Update cross-references

### 4. Validation Before Commit

Always verify:
- [ ] Functionality still works (test critical paths)
- [ ] All cross-references updated
- [ ] No broken links in markdown
- [ ] Git diff shows expected changes
- [ ] Commit message is descriptive

## Metrics & Results

### Token Reduction
- **Before**: 73k tokens (36.5% of context)
- **After**: ~61k tokens (~30% of context)
- **Savings**: ~12k tokens (16% reduction in MCP context)

### Line Count Reduction
- **mcp-servers.md**: 294 → 199 lines (32% reduction)
- **Net project lines**: -83 lines (148 deleted, 65 added)
- **New on-demand doc**: +500 lines (but only loaded when needed)

### File Changes
- **Created**: 1 new on-demand doc
- **Modified**: 3 context files
- **Removed**: 1 MCP server configuration

## Reusable Consolidation Workflow

### Step-by-Step Template

1. **Identify Problem**
   - [ ] Use `/context` to find high token consumers
   - [ ] Read relevant files to understand structure
   - [ ] List actual vs documented state
   - [ ] Identify duplicates, bloat, outdated content

2. **Analyze & Plan**
   - [ ] Categorize content: always-needed vs on-demand
   - [ ] Identify duplicates to remove
   - [ ] Plan file structure (what goes where)
   - [ ] List files that need updates

3. **Execute Changes**
   - [ ] Remove duplicates/unused items
   - [ ] Create new on-demand docs
   - [ ] Slim down always-loaded files
   - [ ] Update CLAUDE.md
   - [ ] Update system-state.md
   - [ ] Update cross-references

4. **Validate**
   - [ ] Test critical functionality
   - [ ] Check all references work
   - [ ] Review git diff
   - [ ] Verify expected metrics

5. **Document & Commit**
   - [ ] Write clear commit message
   - [ ] Include metrics in commit
   - [ ] Update recent changes in system-state.md
   - [ ] Push to GitHub

## Application to Other Areas

This methodology can be applied to:

### Agent Definitions
- Current: All agent prompts loaded in context
- Opportunity: Extract to `knowledge/agents/` with minimal stubs in `.claude/agents/`

### Slash Commands
- Current: All command definitions loaded
- Opportunity: Extract complex commands to `knowledge/commands/` with links

### System Documentation
- Current: Some detailed system docs in `.claude/context/systems/`
- Opportunity: Move implementation details to `knowledge/reference/systems/`

### External Source Links
- Current: Some symlinks have accompanying docs
- Opportunity: Extract detailed usage to `knowledge/reference/external-sources/`

## Lessons Learned

### What Worked Well
1. ✅ **Analyzing before acting**: Understanding token distribution first
2. ✅ **On-demand pattern**: Keeps core context slim, details accessible
3. ✅ **Testing functionality**: Verified memory graph worked before committing
4. ✅ **Cascading updates**: Updating references across all affected files
5. ✅ **Clear metrics**: Tracking token/line reduction quantifies value

### What to Improve
1. ⚠️ **Automation opportunity**: Could create `/consolidate-mcp` command for this
2. ⚠️ **Context monitoring**: Could track context usage over time
3. ⚠️ **Documentation templates**: Standardize on-demand doc format

## Future Consolidation Targets

Based on current context usage:

### High Priority
1. **GitHub MCP** (27 tools): Review if all tools needed, extract detailed workflows
2. **Filesystem MCP** (13 tools): Extract security model details to on-demand doc
3. **Agent definitions**: Move detailed prompts to knowledge/agents/

### Medium Priority
1. **System context files**: Review each system/* file for on-demand opportunities
2. **Workflow patterns**: Extract detailed patterns to knowledge/workflows/
3. **Slash command prompts**: Move complex commands to knowledge/commands/

### Low Priority
1. **External source documentation**: Consolidate scattered docs
2. **Historical session notes**: Archive old sessions to reduce index

## Related Documentation

- @.claude/context/workflows/session-exit-procedure.md - Session cleanup
- @knowledge/docs/claude-code-best-practices.md - Project patterns
- @.claude/context/integrations/mcp-servers.md - Current MCP overview
- @knowledge/reference/mcp/playwright-workflows.md - Example on-demand doc

---

**Created**: 2025-11-10
**Purpose**: Document consolidation methodology for `/consolidate-project` enhancement
**Status**: Template ready for reuse
