---
type: claude-knowledge
source: aiprojects
source_path: "knowledge/notes/consolidation-overview-for-slash-command.md"
source_category: "session-knowledge"
synced: 2026-02-17
title: "Consolidation Overview: Infrastructure Context vs Project Knowledge"
tags:
  - claude-knowledge
  - session-knowledge
---

# Consolidation Overview: Infrastructure Context vs Project Knowledge

**Date**: 2025-11-10
**Purpose**: Document two types of consolidation for `/consolidate-project` enhancement

## Two Types of Consolidation

### Type 1: Project Knowledge Consolidation
**Current `/consolidate-project` command**

**Target**: `.claude/projects/<project-name>/` directories
**Purpose**: Organize learned patterns, examples, and progress for user projects (e.g., blog writing)
**Frequency**: Daily or on-demand
**Focus**: User-facing work products

**Example Structure**:
```
.claude/projects/ciso-blog-writing/
â”œâ”€ README.md
â”œâ”€ config.yaml
â”œâ”€ learned-patterns.md
â”œâ”€ progress.md
â”œâ”€ examples/
â”‚  â”œâ”€ good/
â”‚  â””â”€ archive/
â””â”€ knowledge/
   â”œâ”€ style-guide.md
   â”œâ”€ preferences.md
   â””â”€ troubleshooting.md
```

### Type 2: Infrastructure Context Consolidation
**What I just did with MCP**

**Target**: `.claude/context/` and `knowledge/reference/` directories
**Purpose**: Optimize Claude Code's context window usage
**Frequency**: As needed when context bloats
**Focus**: System configuration, tool definitions, infrastructure documentation

**Example Structure**:
```
.claude/context/integrations/mcp-servers.md (slim, always loaded)
â””â”€ References â†’ knowledge/reference/mcp/
                 â”œâ”€ playwright-workflows.md (on-demand)
                 â”œâ”€ docker-mcp.md (on-demand)
                 â””â”€ github-mcp.md (on-demand)
```

## What I Did: MCP Context Consolidation

### Overview
Optimized MCP tool definitions from 73k tokens (36.5%) â†’ ~61k tokens (~30%), saving ~12k tokens

### The Consolidation Process

#### 1. Problem Identification
```
Input: User noticed MCP tools consuming 36.5% of context window
Action: Analyzed with /context command
Output: Identified 3 issues:
  - Duplicate memory server (standalone + gateway)
  - 150+ lines of detailed Playwright workflows in always-loaded context
  - postgres-n8n failing but marked as critical
```

#### 2. Strategy Development
```
Three approaches:
1. Remove duplicates â†’ Remove standalone memory server
2. Extract to on-demand â†’ Move Playwright workflows to knowledge/reference/
3. Update status â†’ Mark postgres-n8n as "fix later" (low priority)
```

#### 3. Execution Pattern
```
Phase 1: Remove Duplicates
  âœ“ Test functionality (memory graph via gateway)
  âœ“ Remove standalone server (claude mcp remove memory)

Phase 2: Extract Content
  âœ“ Create on-demand doc (knowledge/reference/mcp/playwright-workflows.md)
  âœ“ Slim source file (mcp-servers.md: 294â†’199 lines, -32%)
  âœ“ Update references to point to new location

Phase 3: Update Documentation
  âœ“ CLAUDE.md - Add "on-demand documentation" pattern
  âœ“ system-state.md - Update MCP status, mark postgres-n8n
  âœ“ mcp-servers.md - Replace detailed content with quick reference

Phase 4: Validate
  âœ“ Test memory graph still works
  âœ“ Review git diff stats (-83 net lines)
  âœ“ Verify all references updated

Phase 5: Commit
  âœ“ Descriptive commit with metrics
  âœ“ Push to GitHub
```

#### 4. Key Pattern: Always-Loaded vs On-Demand

**Before** (everything loaded):
```
.claude/context/integrations/mcp-servers.md (294 lines)
â”œâ”€ Quick reference
â”œâ”€ Server descriptions
â”œâ”€ Tool priority strategy
â”œâ”€ Browser automation workflows (150+ lines)
â”œâ”€ Common patterns
â”œâ”€ Tool reference (21 tools)
â”œâ”€ Best practices
â”œâ”€ Error handling
â””â”€ Troubleshooting
```

**After** (slim always-loaded + detailed on-demand):
```
.claude/context/integrations/mcp-servers.md (199 lines)
â”œâ”€ Quick reference
â”œâ”€ Server descriptions
â”œâ”€ Tool priority strategy
â”œâ”€ Browser automation quick reference (15 lines)
â”‚  â””â”€ Link â†’ @knowledge/reference/mcp/playwright-workflows.md
â”œâ”€ Common patterns
â””â”€ Troubleshooting

knowledge/reference/mcp/playwright-workflows.md (500+ lines, loaded when needed)
â”œâ”€ Complete tool reference (21 tools)
â”œâ”€ Detailed workflows
â”œâ”€ Common task patterns
â”œâ”€ Best practices
â”œâ”€ Error handling
â””â”€ Integration examples
```

### Results
- **Token reduction**: ~12k tokens saved (16% reduction in MCP context)
- **Line reduction**: 294â†’199 lines in mcp-servers.md (32% reduction)
- **Functionality**: 100% preserved (tested memory graph)
- **Maintainability**: Improved (detailed docs easier to update separately)

## Enhancing `/consolidate-project`

### Option 1: Add Infrastructure Mode

Add a new mode to existing command:

```bash
/consolidate-project                    # Current: project knowledge
/consolidate-project --infrastructure   # New: infrastructure context
/consolidate-project --all             # Both types
```

### Option 2: Create New Command

Keep project command separate, create new one:

```bash
/consolidate-project <project-name>     # Existing: project knowledge
/consolidate-context                    # New: infrastructure context
```

### Option 3: Automatic Detection

Smart consolidation based on what needs it:

```bash
/consolidate                           # Analyzes context usage, suggests targets
```

## Recommended Enhancement: Add Infrastructure Mode

### Proposed `/consolidate-project --infrastructure` Flow

```markdown
## Infrastructure Context Consolidation

### Step 1: Analyze Context Usage
1. Run `/context` to see token distribution
2. Identify high-token consumers (>10k tokens or >15%)
3. Read relevant context files to understand structure

### Step 2: Identify Consolidation Opportunities

Check for:
- [ ] **Duplicates**: Same content in multiple places
- [ ] **Detail bloat**: Detailed content in always-loaded context
- [ ] **Outdated content**: References to removed/inactive systems
- [ ] **Large embedded data**: Tool definitions, reference docs in context

Common targets:
- `.claude/context/integrations/mcp-servers.md`
- `.claude/context/systems/*/*.md`
- `.claude/agents/*.md` (agent definitions)
- `.claude/commands/*.md` (slash commands)

### Step 3: Apply Consolidation Pattern

For each target:

1. **Categorize content**:
   - Always-needed: Keep in `.claude/context/`
   - On-demand: Move to `knowledge/reference/`
   - Outdated: Archive or remove

2. **Extract detailed content**:
   ```
   Create: knowledge/reference/<category>/<topic>.md
   Slim: .claude/context/<category>/<topic>.md
   Update: References in CLAUDE.md
   ```

3. **Update cross-references**:
   - CLAUDE.md - Add to "On-Demand Documentation" section
   - system-state.md - Update status if applicable
   - Other context files - Update links

### Step 4: Remove Duplicates/Unused

Check for:
- Duplicate MCP servers
- Inactive services marked as critical
- Outdated system documentation
- Unused agent definitions

### Step 5: Validate Changes

- [ ] Test critical functionality (e.g., MCP tools)
- [ ] Verify all references updated
- [ ] Check git diff shows expected changes
- [ ] Run `/context` to see new token usage

### Step 6: Document & Commit

1. Update system-state.md Recent Changes
2. Create descriptive commit with metrics:
   ```
   Consolidate infrastructure context: <target>

   - Removed/extracted: <what>
   - Moved to on-demand: <what>
   - Updated references: <where>
   - Token reduction: ~<X>k tokens (<X>% reduction)

   Files changed: <list>
   ```

### Step 7: Report Results

```
âœ… Infrastructure context consolidated

ğŸ“Š Token Reduction:
- Before: <X>k tokens (<X>%)
- After: <Y>k tokens (<Y>%)
- Saved: ~<Z>k tokens (<Z>% reduction)

ğŸ“ Changes:
- Extracted: <file1> â†’ knowledge/reference/<path>
- Slimmed: <file2> (<before>â†’<after> lines)
- Removed: <item1>, <item2>

ğŸ”— On-Demand Docs:
- @knowledge/reference/<doc1>
- @knowledge/reference/<doc2>

âœ“ All functionality tested and working
âœ“ Cross-references updated
âœ“ Committed: <commit-hash>
```
```

## Integration with Existing Command

### Updated `/consolidate-project` Usage

```bash
# Project knowledge consolidation (existing)
/consolidate-project ciso-blog-writing

# Infrastructure context consolidation (new)
/consolidate-project --infrastructure

# Consolidate both (new)
/consolidate-project --all

# Smart consolidation (new)
/consolidate-project --analyze  # Suggests what needs consolidation
```

### Argument Processing

```yaml
# In .claude/commands/consolidate-project.md

argument-hint: [project-name | --infrastructure | --all | --analyze]

# Parse arguments:
- If starts with "--": Infrastructure mode
- If valid project name: Project mode
- If empty: Ask user which mode
```

## Example Scenarios

### Scenario 1: MCP Context Bloat (What I Just Did)
```
User: "MCP tools are taking 35% of context"
Command: /consolidate-project --infrastructure
Target: .claude/context/integrations/mcp-servers.md
Actions:
  - Remove duplicate memory server
  - Extract Playwright workflows â†’ knowledge/reference/mcp/
  - Update references in CLAUDE.md
Result: 73k â†’ 61k tokens (~12k saved)
```

### Scenario 2: Agent Definitions Bloat
```
User: "Agent definitions seem heavy"
Command: /consolidate-project --infrastructure
Target: .claude/agents/*.md
Actions:
  - Analyze agent prompt sizes
  - Extract detailed prompts â†’ knowledge/agents/
  - Keep minimal stubs in .claude/agents/
  - Update agent system to load detailed prompts
Result: Reduce agent context by ~50%
```

### Scenario 3: System Documentation Sprawl
```
User: "System docs in context seem redundant"
Command: /consolidate-project --infrastructure
Target: .claude/context/systems/*/*.md
Actions:
  - Identify duplicates (e.g., docker in multiple places)
  - Extract detailed guides â†’ knowledge/reference/systems/
  - Keep quick reference in context
Result: Cleaner context, better organization
```

## Comparison: Project vs Infrastructure Consolidation

| Aspect | Project Knowledge | Infrastructure Context |
|--------|------------------|----------------------|
| **Target** | .claude/projects/<name>/ | .claude/context/, knowledge/ |
| **Purpose** | Organize learned patterns | Optimize context window |
| **Frequency** | Daily or after sessions | As needed (monthly?) |
| **Metrics** | Patterns, examples, insights | Tokens, lines, file count |
| **Output** | Project summary | Token reduction report |
| **Validation** | Review quality | Test functionality |
| **Focus** | Content organization | Performance optimization |

## Recommended Next Steps

1. **Update `/consolidate-project` command**:
   - Add `--infrastructure` mode following pattern above
   - Keep existing project mode unchanged
   - Add `--analyze` mode to suggest targets

2. **Create consolidation methodology doc** (done):
   - âœ“ knowledge/notes/consolidation-methodology-mcp-context-optimization.md
   - Reference in enhanced command

3. **Document infrastructure consolidation targets**:
   - Create knowledge/maintenance/context-optimization-targets.md
   - List: MCP servers, agents, system docs, slash commands
   - Include token thresholds for action

4. **Add to regular maintenance**:
   - Monthly: Run `/consolidate-project --analyze`
   - When context >80%: Run `/consolidate-project --infrastructure`
   - After major changes: Review context impact

## Template for Command Enhancement

See full proposed command update in:
- @knowledge/notes/consolidation-methodology-mcp-context-optimization.md (detailed methodology)
- This file (integration approach)

Key sections to add to `/consolidate-project.md`:
1. Argument parsing for infrastructure mode
2. Context analysis workflow (Step 1-2 above)
3. On-demand pattern application (Step 3 above)
4. Infrastructure-specific validation (Step 5 above)
5. Token reduction reporting (Step 7 above)

---

**Created**: 2025-11-10
**Purpose**: Bridge project and infrastructure consolidation for `/consolidate-project` enhancement
**Next Action**: Update `.claude/commands/consolidate-project.md` with infrastructure mode
