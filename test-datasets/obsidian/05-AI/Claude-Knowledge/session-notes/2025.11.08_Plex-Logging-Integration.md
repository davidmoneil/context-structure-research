---
type: claude-knowledge
source: aiprojects
source_path: "knowledge/notes/session-20251108-plex-logging-integration.md"
source_category: "session-knowledge"
synced: 2026-02-17
title: "Session Notes: Plex Logging Integration - Troubleshooting & Documentation"
tags:
  - claude-knowledge
  - session-knowledge
---

# Session Notes: Plex Logging Integration - Troubleshooting & Documentation

**Date**: 2025-11-08
**Duration**: ~2 hours
**Focus**: Diagnose and fix Plex → Loki integration, create comprehensive documentation

---

## Objectives Completed

1. ✅ Diagnosed why `{job="plex"}` query was returning no results in Grafana
2. ✅ Fixed Grafana Alloy configuration to properly set labels
3. ✅ Defined comprehensive Plex log schema
4. ✅ Documented firewall requirements for Loki ingestion
5. ✅ Created extensive troubleshooting documentation
6. ✅ Updated logging architecture with Plex as active source

---

## Technical Details

### Problem Diagnosis

**User Report**: Plex logs flowing to Loki, but `{job="plex"}` query returns no results.

**Investigation**:
```bash
# Checked available job labels
curl -s "http://localhost:3100/loki/api/v1/label/job/values" | jq '.'
# Result: ["docker", "syslog", "test"] - NO "plex"

# Found Plex logs by filename
curl -s "http://localhost:3100/loki/api/v1/label/filename/values" | jq '.'
# Result: Multiple Plex log files found (C:\Users\MediaServer\...\Plex Media Server*.log)

# Confirmed data flowing, but job label not set
```

**Root Cause**: In Grafana Alloy, labels must be defined in `path_targets` metadata OR using `stage.static_labels`. The original config only had labels in `stage.labels`, which doesn't work for setting initial stream labels.

### Solution Implemented

**Original Config** (broken):
```alloy
local.file_match "plex_logs" {
  path_targets = [
    { __path__ = "C:\\...\\Plex Media Server*.log", component = "server" },
    # ❌ No job label here
  ]
}

loki.process "plex_pipeline" {
  stage.labels {
    values = {
      job  = "plex",   # ❌ This doesn't work for initial labels
      host = sys.env("COMPUTERNAME"),
    }
  }
}
```

**Fixed Config**:
```alloy
local.file_match "plex_logs" {
  path_targets = [
    {
      __path__    = "C:\\...\\Plex Media Server*.log",
      component   = "server",  # ✅ Auto-labeled
      job         = "plex",    # ✅ Fixed - added here
    },
  ]
}

loki.process "plex_pipeline" {
  stage.static_labels {
    values = {
      host = "MediaServer",  # ✅ Static value
    }
  }
}
```

### Log Schema Defined

**Labels** (indexed, used for filtering):
```yaml
job: "plex"                    # Static - identifies as Plex logs
host: "MediaServer"            # Static - Windows hostname
component: "server|scanner|dlna"  # From filename pattern
level: "DEBUG|INFO|WARN|ERROR|FATAL"  # Optional, extracted from log
filename: "C:\Users\..."       # Auto-added by Alloy
```

**Log Format**:
```
Nov 08, 2025 13:52:28.312 [4568] DEBUG - Media Scanner: Scanning /media/movies
```

Pattern: `<Month> <Day>, <Year> <HH>:<MM>:<SS>.<ms> [<ThreadID>] <LEVEL> - <Message>`

### Port Clarification

**Important Discovery**:
- **Loki** (log ingestion): Port **3100** ← Alloy pushes logs here
- **Grafana** (web UI): Port **3001** (external), 3000 (internal)

User was confused about port 3001 vs 3100. Clarified that Alloy must push to port 3100.

### Firewall Configuration

**AIServer (Loki host)**:
```bash
# Allow Alloy from MediaServer to Loki port
sudo ufw allow from 192.168.1.179 to any port 3100 proto tcp comment 'Loki - Alloy from MediaServer'
```

**Verification**:
```bash
# Check Loki listening
docker port loki
# Output: 3100/tcp -> 0.0.0.0:3100

# Test from MediaServer
Test-NetConnection -ComputerName 192.168.1.196 -Port 3100
curl http://192.168.1.196:3100/ready
```

---

## Lessons Learned

### What Went Well

1. **Methodical Diagnosis**: Started with checking available labels in Loki before assuming config issue
2. **Found Data Quickly**: Used `filename` label to confirm data was flowing, narrowed down to label issue
3. **Comprehensive Documentation**: Created extensive docs to prevent future issues
4. **Schema Definition**: Defined clear log schema upfront for consistency
5. **Port Clarification**: Cleared up confusion between Grafana UI (3001) and Loki API (3100)

### Challenges

1. **Alloy Label Syntax**: Not immediately obvious that labels need to be in `path_targets`, not just pipeline stages
2. **Query Debugging**: Loki API errors were cryptic when trying to query with jq
3. **Level Label**: Initially tried to require level, but not all Plex logs have explicit levels

### Solutions Found

1. **Path Targets Metadata**: Discovered that `path_targets` automatically adds metadata as labels
2. **Static Labels Stage**: Used `stage.static_labels` for host instead of `sys.env()` for reliability
3. **Optional Level**: Made level extraction optional using `stage.match` so logs without levels aren't dropped

### Best Practices Confirmed

1. **MCP Tools First**: Used Docker MCP for container inspection (list-containers, get-logs)
2. **Documentation**: Created comprehensive docs immediately after solving problem
3. **Schema Definition**: Defined schema before deployment prevents label chaos later
4. **Version Control**: Committed config to git for backup/reference
5. **Troubleshooting Docs**: Documented step-by-step troubleshooting for future reference

---

## Files Modified

### Created
- `.claude/context/systems/logging/plex-integration.md` - Comprehensive Plex logging guide (900+ lines)
  - Architecture and data flow
  - Alloy configuration with explanation
  - 30+ LogQL query examples
  - Troubleshooting procedures (step-by-step)
  - Health checks and verification
  - Performance tuning guidance
- `plex-alloy-config.alloy` - Corrected Alloy config ready for deployment

### Updated
- `.claude/context/systems/logging/architecture.md` - Added Plex as active log source
- `paths-registry.yaml` - Added Grafana Alloy config paths and schema
- `.claude/context/session-state.md` - Updated with session progress

---

## Current State

### AIServer (192.168.1.196)
- **Loki**: Running, listening on port 3100
- **Grafana**: Running, accessible on port 3001
- **Firewall**: Awaiting user to add UFW rule for port 3100 from MediaServer
- **Git**: All changes committed, ready to push

### MediaServer (192.168.1.179 - Windows)
- **Grafana Alloy**: Installed, currently running with broken config
- **Plex Logs**: Flowing to Loki but with incorrect labels
- **Corrected Config**: Available at `/home/davidmoneil/AIProjects/plex-alloy-config.alloy` (on AIServer)
- **Status**: Awaiting user deployment

### Git Repositories
- **AIProjects**: 1 commit ahead of origin/main, working tree clean
- **mydocker**: Not modified this session

---

## Next Steps (User Deployment)

### Immediate (User)
1. **Add firewall rule** on AIServer:
   ```bash
   sudo ufw allow from 192.168.1.179 to any port 3100 proto tcp comment 'Loki - Alloy from MediaServer'
   ```

2. **Deploy corrected config** on MediaServer:
   - Copy from: `/home/davidmoneil/AIProjects/plex-alloy-config.alloy` (AIServer)
   - Save to: `C:\Program Files\GrafanaLabs\Alloy\config.alloy` (MediaServer)

3. **Restart Alloy service** (MediaServer):
   ```powershell
   Restart-Service Alloy
   ```

4. **Verify logs flowing**:
   - Alloy UI: `http://localhost:12345` (MediaServer)
   - Check targets tab (should show 3 healthy targets)
   - Grafana: `{job="plex"}` (AIServer)

### Future (Optional)
1. **Create Grafana dashboard** for Plex monitoring
2. **Configure alerts** for high error rates
3. **Tune retention** if 90d is too much/little
4. **MCP integration** for log querying via Claude Code

---

## Query Examples for Testing

Once deployed, test with these queries:

```logql
# Basic verification
{job="plex"}

# By component
{job="plex", component="server"}
{job="plex", component="scanner"}

# By level
{job="plex", level="ERROR"}
{job="plex", level="WARN"}

# Combined filters
{job="plex", component="server", level="ERROR"}

# Text search
{job="plex"} |= "user"
{job="plex"} |~ "(?i)transcode"

# Metrics
sum(rate({job="plex", level="ERROR"}[1m]))
sum by (component) (rate({job="plex"}[5m]))
topk(10, count_over_time({job="plex", level="ERROR"}[1h]))
```

---

## References

### Documentation Created
- `/home/davidmoneil/AIProjects/.claude/context/systems/logging/plex-integration.md`
- `/home/davidmoneil/AIProjects/plex-alloy-config.alloy`

### External Resources
- Grafana Alloy Docs: https://grafana.com/docs/alloy/
- Loki API Reference: https://grafana.com/docs/loki/latest/api/
- LogQL Query Language: https://grafana.com/docs/loki/latest/logql/

### Network Details
- **AIServer**: 192.168.1.196 (Loki:3100, Grafana:3001)
- **MediaServer**: 192.168.1.179 (Plex, Alloy)
- **Loki Push Endpoint**: http://192.168.1.196:3100/loki/api/v1/push

---

## Session Exit Checklist

- [x] Session todos cleared (no todos used this session)
- [x] current-priorities.md updated (Plex integration completed items documented)
- [x] All changes committed to git (commit 3173e8b)
- [ ] Changes pushed to GitHub (awaiting push)
- [x] Session notes created (this file)
- [x] No pending issues or blockers (awaiting user deployment)
- [x] session-state.md updated (status: idle, awaiting user deployment)

---

## Post-Session Summary

**Accomplishment**: Successfully diagnosed and fixed Plex → Loki integration issue. The problem was subtle (label placement in Alloy config) but once identified, the fix was straightforward. Created comprehensive documentation that should prevent similar issues in the future and provide excellent reference for Plex log querying.

**Documentation Quality**: Created one of the most comprehensive integration docs yet (900+ lines), including architecture, configuration, 30+ query examples, troubleshooting, health checks, and performance tuning. This will serve as a template for future logging integrations.

**User Experience**: Provided clear deployment steps, config file ready to copy, and verification procedures. User should be able to deploy in < 5 minutes and immediately start querying Plex logs.

**Follow-up**: Once user deploys and verifies logs flowing, consider creating Grafana dashboard for Plex monitoring (sessions, errors, scanner activity).
