---
type: claude-knowledge
source: aiprojects
source_path: "knowledge/notes/session-20251110-mcp-workflow-testing.md"
source_category: "session-knowledge"
synced: 2026-02-17
title: "Session Notes: MCP Workflow Testing (2025-11-10)"
tags:
  - claude-knowledge
  - session-knowledge
---

# Session Notes: MCP Workflow Testing (2025-11-10)

**Session Type**: Testing and validation
**Duration**: ~1 hour
**Focus**: Testing dynamic MCP management workflow from previous session

## Objectives

Test the three-tier MCP management strategy proposed in the previous session:
1. Measure actual context savings
2. Validate workflow feasibility
3. Identify limitations
4. Decide on GitHub issue submission

## Test Results

### Context Usage Measurements

| Configuration | MCP Tokens | Total Tokens | Savings | Percentage |
|--------------|------------|--------------|---------|------------|
| **Baseline** (7 servers) | 67.3k | 107.0k | - | - |
| **Optimized** (3 servers) | 42.6k | 82.3k | 24.7k | 36.7% |
| **Expected** (3 servers, post-restart) | ~38-40k | ~78-80k | ~27-29k | ~40% |

**Servers Configuration**:
- **Baseline**: filesystem, git, mcp-gateway, docker, github, ssh, postgres-n8n (broken)
- **Optimized**: filesystem, git, mcp-gateway (Tier 1 only)

### Key Findings

✅ **What Worked**:
1. Three-tier strategy validated - significant context savings achieved (36.7%)
2. Tier 1 servers provide adequate functionality for most sessions
3. Manual server removal via `claude mcp remove` works reliably
4. Context reduction allows for deeper file analysis and longer conversations

⚠️ **Limitations Discovered**:
1. **Session Restart Required**: MCP changes don't take effect until session restart
2. **Complex Command Syntax**: `claude mcp add` requires full server configuration (type, command, args, env), not just server name
3. **No Mid-Session Toggling**: Cannot dynamically add/remove servers during conversation
4. **Manual Workflow Burden**: Requires editing ~/.claude.json or remembering complex commands
5. **Still High Context Usage**: Even with only 3 servers, 42.6k tokens (21.3%) consumed

### Architecture Analysis

**Why 42.6k tokens with only 3 servers?**

The MCP Gateway is actually 3 sub-servers in one:
- Memory (9 tools)
- Fetch (1 tool)
- Playwright (21 tools)

Total: 31 tools from mcp-gateway alone, explaining the higher-than-expected token usage.

## Actions Taken

### 1. Documentation Updates

**Updated Files**:
- `.claude/context/workflows/dynamic-mcp-management.md`
  - Added real measurement results
  - Documented command syntax limitations
  - Added session restart requirements
  - Provided recommended workflows

- `.claude/context/integrations/mcp-servers.md`
  - Reorganized into Tier 1 (active) vs Tier 2 (disabled) sections
  - Updated server count and status
  - Added enablement instructions
  - Documented removed servers

- `drafts/github-issue-mcp-lazy-load.md`
  - Updated with actual test results
  - Added Configuration B measurements (3 servers)
  - Enhanced workaround limitations section

### 2. Configuration Changes

**Removed Servers**:
- `postgres-n8n` - Broken connection, unused functionality
- `docker-mcp` - Moved to Tier 2 (session-based)
- `github` - Moved to Tier 2 (session-based)
- `ssh` - Moved to Tier 2 (session-based)

**Active Servers** (Tier 1):
- `filesystem` - Cross-directory file operations
- `git` - Local repository operations
- `mcp-gateway` - Memory, Fetch, Playwright

### 3. GitHub Issue Submission

**Issue Created**: [#11364](https://github.com/anthropics/claude-code/issues/11364)

**Title**: Lazy-load MCP tool definitions to reduce context usage

**Key Points**:
- Real measurements: 67.3k → 42.6k tokens (36.7% reduction)
- Proposed three-tier lazy-loading architecture
- Expected savings: 67k → ~10k tokens (85% reduction)
- Implementation considerations and alternatives

**Recommendation**: APPROVED and submitted

**Reasoning**:
- Problem validated with real data
- Clear architectural solution
- Benefits entire community
- Workaround insufficient (still 21.3% context used)

## Lessons Learned

### About MCP Architecture

1. **Tool Definitions Are Heavy**: Each tool consumes 550-850 tokens
2. **Gateway Servers Multiply**: Gateway servers can contain multiple sub-servers
3. **No Lazy Loading**: All definitions loaded upfront, regardless of usage
4. **Restart Dependency**: Architecture requires session restart for config changes

### About Workflow Design

1. **Manual Workarounds Have Limits**: Even aggressive optimization (3 servers) still uses 21.3% of context
2. **Command Complexity**: `claude mcp add` is not user-friendly for dynamic toggling
3. **Predictive Loading Difficult**: Hard to know which tools needed before session starts
4. **Context Budget Planning**: Users forced to choose between tools and conversation depth

### About Testing Methodology

1. **Measure Before and After**: `/context` command provides exact token counts
2. **Account for Sub-Servers**: Gateway-style servers increase tool count significantly
3. **Session Isolation**: Must restart to see true impact of changes
4. **Remove Dead Weight**: Broken servers (postgres-n8n) should be removed immediately

## Recommendations

### Short-Term (User Actions)

1. **Keep Tier 1 Active**: filesystem, git, mcp-gateway for most sessions
2. **Session-Based Tier 2**: Manually enable docker/github/ssh when needed
3. **Edit Config Directly**: Faster than complex `claude mcp add` commands
4. **Restart After Changes**: Required for changes to take effect

### Medium-Term (Project Maintenance)

1. **Fix postgres-n8n**: Either repair connection or document removal reason
2. **Create Server Profiles**: Document common server combinations for different tasks
3. **Update Session Exit Procedure**: Add step to disable Tier 2 servers
4. **Monitor Context Usage**: Regular `/context` checks to track optimization

### Long-Term (Feature Request)

1. **Lazy Loading Architecture** (#11364): Primary solution to context problem
2. **Simplified MCP Commands**: `claude mcp add <server-name>` should work
3. **Mid-Session Toggling**: Enable/disable without restart
4. **Profile Support**: Pre-defined server sets (docker-session, github-session, etc.)

## Follow-Up Tasks

- [ ] Restart session to measure true Tier 1 context (~38-40k expected)
- [ ] Document common server profiles for different task types
- [ ] Update session-exit-procedure.md with Tier 2 cleanup
- [ ] Monitor GitHub issue #11364 for community feedback
- [ ] Consider creating `/mcp-profile` slash command for quick switching

## Related Documentation

- **Workflow**: @.claude/context/workflows/dynamic-mcp-management.md
- **MCP Reference**: @.claude/context/integrations/mcp-servers.md
- **GitHub Issue**: https://github.com/anthropics/claude-code/issues/11364
- **Previous Session**: Session 7 (Dynamic MCP Management Workflow creation)

## Statistics

- **Files Modified**: 3
- **Commits**: 1
- **GitHub Issues Created**: 1
- **Servers Removed**: 4
- **Context Saved**: 24.7k tokens (36.7%)
- **Lines Added**: 142
- **Lines Removed**: 44

## Session Outcome

✅ **Success** - All objectives met:
- [x] Measured actual context savings (36.7%)
- [x] Validated workflow feasibility (works but has limitations)
- [x] Identified limitations (session restart, command complexity)
- [x] Decided on GitHub issue (submitted #11364)
- [x] Documented findings comprehensively
- [x] Committed all changes
- [x] Created session notes

---

**Session Status**: Complete
**Next Session**: Normal operations with optimized Tier 1 configuration
**Expected Context**: ~78-80k total tokens after restart
