---
type: claude-knowledge
source: aiprojects
source_path: "knowledge/notes/session-20260117-voice-middleware.md"
source_category: "session-knowledge"
synced: 2026-02-17
title: "Session Notes: Voice Middleware Implementation"
tags:
  - claude-knowledge
  - session-knowledge
---

# Session Notes: Voice Middleware Implementation

**Date**: 2026-01-17
**Duration**: ~3.5 hours
**Focus**: Voice Middleware - Phases 1 & 2

---

## Summary

Built a Voice Middleware system to bridge audio services (Chatterbox TTS) with creative projects. Completed container upgrade with Web UI and REST API layer.

---

## Decision: Hybrid Approach

**User Choices**:
1. **Storage**: Hybrid (SQLite + PostgreSQL sync)
2. **Web UI**: Use devnen's Chatterbox-TTS-Server (instant UI)
3. **Design**: Generic API-first (multi-project support)

**Rationale**: SQLite for CLI portability, PostgreSQL for n8n integration, Web UI for ad-hoc generation, API for programmatic access.

---

## Phase 1: Container Swap & Web UI ✅

### What Changed

| Before | After |
|--------|-------|
| `travisvn/chatterbox-tts-api` | `devnen/Chatterbox-TTS-Server` |
| API only | Web UI + API |
| Basic TTS | Engine selector, presets, voice library |

### Key Files

```
/home/davidmoneil/Docker/mydocker/chatterbox-tts/
├── docker-compose.yml          # Updated for devnen image
├── docker-compose.yml.backup   # Original config
├── config.yaml                 # Server configuration
├── ui-presets.yaml             # D&D-specific presets
├── devnen-server/              # Cloned repo (build source)
├── voices/                     # 28 predefined voices
│   ├── Alexander.wav
│   ├── Alice.wav
│   └── ... (26 more)
├── reference_audio/            # Voice cloning references
├── output/                     # Generated audio
└── logs/                       # Server logs
```

### D&D Presets Created

| Preset | Exaggeration | Use Case |
|--------|--------------|----------|
| DM Narrator - Dramatic | 0.75 | Combat, reveals |
| DM Narrator - Calm | 0.3 | Travel, peaceful |
| DM Narrator - Mysterious | 0.5 | Foreshadowing |
| Grizzled Veteran NPC | 0.5 | Old soldiers |
| Nervous Informant | 0.7 | Suspicious NPCs |
| Wise Elder/Sage | 0.35 | Mentors |
| Villain - Menacing | 1.1 | Main villains |
| Tweenagers Cartoon Villain | 0.7 | Kid-friendly villains |
| Friendly Innkeeper | 0.55 | Tavern keepers |
| Town Guard - Gruff | 0.4 | Guards |
| Excited Child NPC | 0.75 | Children |

### Access URLs

- **Web UI**: `http://192.168.1.196:8100`
- **API Docs**: `http://192.168.1.196:8100/docs`
- **Model Info**: `http://localhost:8100/api/model-info`

---

## Phase 2: REST API Layer ✅

### API Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/characters` | List all characters |
| GET | `/api/characters?workspace=X` | Filter by workspace |
| GET | `/api/characters/search?q=X` | Search characters |
| GET | `/api/characters/:id` | Get by ID or name |
| POST | `/api/characters` | Create character |
| PUT | `/api/characters/:id` | Update character |
| DELETE | `/api/characters/:id` | Delete character |
| POST | `/api/generate` | Generate voice |
| POST | `/api/generate/batch` | Batch generation |
| GET | `/api/voices` | List voice references |
| POST | `/api/voices/:id` | Upload voice reference |
| DELETE | `/api/voices/:id` | Remove voice reference |
| GET | `/api/health` | Basic health |
| GET | `/api/status` | Full status |
| GET | `/api/docs` | API documentation |

### Key Files

```
/home/davidmoneil/Code/voice-character-system/
├── package.json                # v2.0.0, added express, cors, multer
├── src/
│   ├── server.ts               # NEW - Express entry point
│   ├── routes/
│   │   ├── characters.ts       # NEW - CRUD endpoints
│   │   ├── generation.ts       # NEW - TTS proxy
│   │   ├── voices.ts           # NEW - Voice library
│   │   └── health.ts           # NEW - Health/status
│   ├── api/                    # Existing Chatterbox/Whisper clients
│   ├── cli/                    # Existing CLI (unchanged)
│   ├── models/                 # Existing types
│   └── services/               # Existing database
├── Dockerfile                  # NEW - Containerization
└── docker-compose.yml          # NEW - Deployment config
```

### Voice-to-Predefined Mapping

The API automatically maps character voice descriptions to predefined voices:

```javascript
const voiceMap = {
  'male-adult': 'Alexander.wav',
  'male-young': 'Austin.wav',
  'male-elderly': 'Thomas.wav',
  'female-adult': 'Alice.wav',
  'female-young': 'Emily.wav',
  'female-elderly': 'Cora.wav',
  'neutral-adult': 'Jordan.wav'
};
```

---

## Usage Examples

### Web UI (Ad-hoc Generation)

1. Open `http://192.168.1.196:8100`
2. Select preset (e.g., "DM Narrator - Dramatic")
3. Type text
4. Click Generate
5. Download WAV

### API (Programmatic)

```bash
# Create character
curl -X POST http://localhost:8200/api/characters \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Whisper Maren",
    "voice_description": {"age": "young", "gender": "female", "tone": "nervous"},
    "workspace": "tweenagers"
  }'

# Generate voice
curl -X POST http://localhost:8200/api/generate \
  -H "Content-Type: application/json" \
  -d '{"character_name": "Whisper Maren", "text": "I heard rumors about the lighthouse."}'
```

### CLI (Still Works)

```bash
voice-char create "Whisper Maren"
voice-char generate "Whisper Maren" "I heard rumors..."
```

---

## Remaining Work

| Phase | Description | Est. Effort |
|-------|-------------|-------------|
| 3. PostgreSQL Sync | Bi-directional SQLite ↔ PostgreSQL | 2-3 hrs |
| 4. n8n Workflows | Character lookup, voice webhooks | 2-3 hrs |
| 5. CreativeProjects | Update agent/skill | 2-3 hrs |
| 6. Documentation | API docs, integration guide | 1-2 hrs |

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────┐
│                    VOICE MIDDLEWARE SYSTEM                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌──────────────────┐     ┌────────────────────────────────────┐   │
│  │ Chatterbox-TTS   │     │ voice-character-system             │   │
│  │ Server (devnen)  │     │ (CLI + REST API + SQLite)          │   │
│  │ :8100            │     │ :8200                              │   │
│  │                  │     │                                     │   │
│  │ • Web UI ✅      │◄────│ • Character CRUD ✅                │   │
│  │ • 28 voices ✅   │     │ • Voice generation ✅              │   │
│  │ • Presets ✅     │     │ • Voice library ✅                 │   │
│  │ • OpenAI API     │     │ • Health/status ✅                 │   │
│  └────────┬─────────┘     └──────────────┬─────────────────────┘   │
│           │                              │                          │
│           │                              ▼                          │
│           │                   ┌──────────────────────┐              │
│           │                   │ PostgreSQL (PENDING) │              │
│           │                   │ • n8n integration    │              │
│           │                   └──────────┬───────────┘              │
│           │                              │                          │
│           ▼                              ▼                          │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │                    INTEGRATION LAYER (PENDING)                  ││
│  │  • n8n workflows  • CreativeProjects  • Any future project     ││
│  └─────────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────────┘
```

---

## Commits

1. **voice-character-system** (`629efe4`):
   - Add REST API layer for voice middleware integration

2. **AIProjects** (`e51e54d`):
   - Session end: Voice Middleware Implementation Phases 1-2 complete

---

## References

- **Orchestration Plan**: `.claude/orchestration/voice-middleware-implementation.yaml`
- **devnen GitHub**: https://github.com/devnen/Chatterbox-TTS-Server
- **paths-registry.yaml**: Updated with new Chatterbox config
- **session-state.md**: Full resume instructions
