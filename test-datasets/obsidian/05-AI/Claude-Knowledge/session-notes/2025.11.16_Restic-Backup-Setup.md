---
type: claude-knowledge
source: aiprojects
source_path: "knowledge/notes/session-20251116-restic-backup-setup.md"
source_category: "session-knowledge"
synced: 2026-02-17
title: "Session Notes: Restic Backup System Implementation"
tags:
  - claude-knowledge
  - session-knowledge
---

# Session Notes: Restic Backup System Implementation

**Date**: 2025-11-16
**Duration**: ~90 minutes
**Focus**: Implement production-ready automated backup system for AIServer

## Objectives Completed

‚úÖ **Full Backup System Implementation**
- Installed and configured Restic for automated daily backups
- Set up encrypted repository on MediaServer NAS (D: drive)
- Created comprehensive backup, monitoring, and restore scripts
- Configured systemd timer for daily 2 AM automated execution
- Tested backup functionality with successful test snapshot
- Created complete disaster recovery documentation

## Technical Details

### Tools & Technologies
- **Restic 0.16.4** - Backup solution (encrypted, deduplicated)
- **SFTP over SSH** - Transport protocol to MediaServer
- **systemd** - Automation (timer and service units)
- **MediaServer NAS** - Backup destination (Windows 11, D: drive, 243 GB free)

### Repository Configuration
- **Location**: `sftp:mediaserver:/D:/Restic/AIServer-Backups`
- **Repository ID**: a5a4ae8caa
- **Encryption**: AES-256-CTR with Poly1305-AES
- **Password**: Securely generated 32-byte random password
- **Password file**: `~/.restic/aiserver-backup-password.txt` (600 permissions)

### Backup Strategy

**Scope**:
- Full filesystem (`/`) backup
- Excludes: `/proc`, `/sys`, `/dev`, `/run`, `/tmp`, Docker overlays, caches
- Includes: All user data, configs, Docker configs, AIProjects

**Schedule**:
- Daily at 2:00 AM MST
- Randomized delay: ¬±30 minutes
- Systemd timer: `restic-backup.timer`

**Retention Policy**:
- Daily: 30 snapshots
- Weekly: 8 snapshots
- Monthly: 12 snapshots
- Yearly: 5 snapshots

**Storage Efficiency**:
- Deduplication: Content-defined chunking (only unique data stored)
- Compression: Automatic per-file (test backup: 44% space savings)
- Incremental: Only changed data uploaded after first backup

### Scripts Created

1. **`/home/davidmoneil/Scripts/restic-backup.sh`**
   - Main backup script with comprehensive exclusions
   - Implements retention policy and pruning
   - Weekly integrity checks (Sundays)
   - Logging to `~/.restic/backup.log`

2. **`/home/davidmoneil/Scripts/restic-status.sh`**
   - Health check monitoring
   - Snapshot listing and statistics
   - Repository size on MediaServer
   - Systemd timer status

3. **`/home/davidmoneil/Scripts/restic-restore.sh`**
   - Interactive restore interface
   - Browse snapshots
   - Restore specific files/directories
   - Mount repository for browsing

### Systemd Configuration

**Service**: `/etc/systemd/system/restic-backup.service`
- Oneshot execution
- Runs as user `davidmoneil`
- Nice priority 19 (low CPU priority)
- I/O scheduling: idle class
- Logs to systemd journal

**Timer**: `/etc/systemd/system/restic-backup.timer`
- Daily at 02:00 (2 AM)
- Randomized delay: 30 minutes
- Persistent (runs on next boot if missed)

### Commands Run

```bash
# Install Restic
sudo apt update && sudo apt install -y restic

# Create backup directory on MediaServer
ssh mediaserver 'powershell -Command "New-Item -ItemType Directory -Path \"D:\Restic\AIServer-Backups\" -Force"'

# Generate secure password
mkdir -p ~/.restic
openssl rand -base64 32 > ~/.restic/aiserver-backup-password.txt
chmod 600 ~/.restic/aiserver-backup-password.txt

# Initialize repository
export RESTIC_REPOSITORY="sftp:mediaserver:/D:/Restic/AIServer-Backups"
export RESTIC_PASSWORD_FILE=~/.restic/aiserver-backup-password.txt
restic init

# Test backup (AIProjects)
restic backup /home/davidmoneil/AIProjects --tag test-backup

# Install systemd units
sudo cp restic-backup.service /etc/systemd/system/
sudo cp restic-backup.timer /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable restic-backup.timer
sudo systemctl start restic-backup.timer

# Verify status
systemctl status restic-backup.timer
restic snapshots
```

## Lessons Learned

### What Went Well

1. **Restic choice validated**
   - Easy setup and configuration
   - Built-in encryption and deduplication
   - SFTP backend works seamlessly with existing SSH setup
   - Excellent documentation

2. **MediaServer SSH infrastructure paid off**
   - Previous MediaServer SSH setup (2025-11-10) made this trivial
   - No additional authentication setup needed
   - Secure transport already in place

3. **Systemd integration smooth**
   - Timer and service units worked first try
   - Persistent timer ensures missed backups run
   - Journal logging provides audit trail

4. **Documentation-driven approach**
   - Created disaster recovery playbook before finishing
   - Documented all scenarios and recovery procedures
   - Future self will thank us

### Challenges

1. **MediaServer IP confusion**
   - Initially tried 192.168.1.199 (wrong)
   - Correct IP: 192.168.1.179
   - Fixed by checking mediaserver-ssh-setup.md context

2. **Sudo access for installation**
   - Claude Code couldn't run `sudo apt install` interactively
   - User ran commands manually (Option B)
   - Alternative: Could download binary directly

3. **Drive selection for backups**
   - User needed clarity on which drive to use
   - Checked drive labels and contents remotely
   - D: drive labeled "Backup" - obvious choice

### Best Practices Confirmed

1. **Context files are critical**
   - mediaserver-ssh-setup.md saved time
   - paths-registry.yaml would help here (not yet updated)

2. **Test before automating**
   - Test backup validated entire chain
   - Caught any issues before first automated run

3. **Security by default**
   - Generated strong random password
   - Set file permissions correctly (600)
   - Used existing SSH keys (no new secrets)

4. **Comprehensive documentation**
   - Disaster recovery playbook is essential
   - Recovery procedures documented before needed
   - User has clear next steps

## Files Modified

### Created
- `/home/davidmoneil/Scripts/restic-backup.sh` (executable)
- `/home/davidmoneil/Scripts/restic-status.sh` (executable)
- `/home/davidmoneil/Scripts/restic-restore.sh` (executable)
- `/etc/systemd/system/restic-backup.service` (systemd unit)
- `/etc/systemd/system/restic-backup.timer` (systemd unit)
- `~/.restic/aiserver-backup-password.txt` (600 permissions)
- `.claude/context/systems/backup-strategy.md` (documentation)
- `.claude/context/systems/backup-disaster-recovery.md` (recovery playbook)

### Modified
- `.claude/context/session-state.md` (session continuity)
- `.claude/context/projects/current-priorities.md` (completed items)

### External
- MediaServer: `D:\Restic\AIServer-Backups` (repository initialized)

## Current State

### Backup System Status
- ‚úÖ Repository initialized (ID: a5a4ae8caa)
- ‚úÖ Test backup successful (snapshot d3762d93, 1,121 files)
- ‚úÖ Systemd timer active (next run: 2025-11-17 ~02:00 MST)
- ‚úÖ Scripts created and validated
- ‚úÖ Documentation complete

### System Configuration
- **Restic version**: 0.16.4
- **Repository**: MediaServer D:\Restic\AIServer-Backups
- **Backup schedule**: Daily 2 AM via systemd
- **Encryption**: AES-256 (password in ~/.restic/)
- **Transport**: SFTP via SSH (key-based auth)

### Git Status
- New files to commit:
  - backup-strategy.md
  - backup-disaster-recovery.md
  - session notes (this file)
- Modified files:
  - session-state.md
  - current-priorities.md

## Next Steps (Suggested)

### Immediate (User Action Required)
1. **üîê CRITICAL: Backup the repository password offline**
   - Password: `oLeYzevOCP4o+fQWSPQYQ3CuuXkmqBxQiexD/Oi6URk=`
   - Store in password manager or encrypted USB drive
   - Without this, backups are UNRECOVERABLE

2. **üîë Backup SSH keys offline**
   - Private key: `~/.ssh/mediaserver_key`
   - Needed for disaster recovery

### Tomorrow Morning (2025-11-17)
3. **Verify first automated backup**
   ```bash
   /home/davidmoneil/Scripts/restic-status.sh health
   ```
   - Expected: Full system backup completed (~280 GB, 1-2 hours)
   - Snapshot created at ~2 AM
   - No errors in logs

### Weekly (Recommended)
4. **Monitor backup health**
   ```bash
   /home/davidmoneil/Scripts/restic-status.sh stats
   ```

### Monthly (Good Practice)
5. **Test restore procedure**
   - Pick a random file to restore
   - Verify password is still accessible
   - Check MediaServer disk space

### Future Enhancements (Optional)
6. **Offsite backup**
   - Consider syncing to Backblaze B2 or AWS S3
   - Implement 3-2-1 backup strategy (3 copies, 2 media types, 1 offsite)

7. **Monitoring integration**
   - Send backup status to n8n workflow
   - Push metrics to Prometheus
   - Create Grafana dashboard

8. **Alert on backup failure**
   - Email notification if backup fails
   - Integration with existing logging stack

## References

### Documentation Created
- `.claude/context/systems/backup-strategy.md` - Complete strategy guide
- `.claude/context/systems/backup-disaster-recovery.md` - Recovery playbook

### Related Context
- `.claude/context/systems/mediaserver-ssh-setup.md` - SSH configuration
- `.claude/context/systems/mediaserver-operations.md` - MediaServer ops guide

### External Resources
- Restic documentation: https://restic.readthedocs.io/
- Restic forum: https://forum.restic.net/

---

## Session Exit Checklist

- [x] Session todos cleared
- [x] current-priorities.md updated (Completed section)
- [x] session-state.md updated
- [x] Session notes created (this file)
- [ ] All changes committed to git (next step)
- [ ] Changes pushed to GitHub (next step)
- [x] Documented critical follow-ups (password backup!)
- [x] No blocking issues

---

**Session Summary**: Successfully implemented production-ready automated backup system for AIServer using Restic with daily backups to MediaServer NAS. Full system disaster recovery capability achieved with comprehensive documentation. First automated backup scheduled for tomorrow at 2 AM.
