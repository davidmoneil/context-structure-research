---
type: claude-knowledge
source: aiprojects
source_path: ".claude/agent-output/results/deep-research/2026-02-10_claude-code-plugin-system.md"
source_category: "deep-research"
synced: 2026-02-17
title: "Deep Research: Claude Code Plugin System"
tags:
  - claude-knowledge
  - deep-research
---

# Deep Research: Claude Code Plugin System

**Research Date**: 2026-02-10
**Confidence Level**: High
**Sources Consulted**: 12+

## Executive Summary

The Claude Code plugin system is a mature, well-documented extension mechanism that allows packaging commands, agents, skills, hooks, MCP servers, and LSP servers into distributable units. Plugins are distributed through "marketplaces" -- git repositories containing a `marketplace.json` catalog file. The official Anthropic marketplace (`claude-plugins-official`) ships 60+ plugins and is auto-available to all Claude Code users.

The plugin format is straightforward: a directory with a `.claude-plugin/plugin.json` manifest and component directories (`commands/`, `agents/`, `skills/`, `hooks/`) at the root level. Plugins are namespaced by their `name` field (e.g., `/my-plugin:command-name`), and installed to a local cache. The system supports five source types: relative paths, GitHub repos, git URLs, npm, and pip (though npm/pip are not yet fully implemented).

For packaging AIfred as a plugin, the format maps cleanly: AIfred's commands become `commands/`, its agents become `agents/`, skills become `skills/`, hooks become `hooks/hooks.json`, and MCP servers become `.mcp.json`. The main work is reorganizing the directory structure and creating the manifest.

---

## Key Findings

### 1. Plugin Packaging Format

#### Directory Structure

```
my-plugin/
├── .claude-plugin/           # Metadata directory (ONLY plugin.json goes here)
│   └── plugin.json           # Plugin manifest (required if metadata needed)
├── commands/                 # Slash commands as .md files
│   ├── status.md
│   └── logs.md
├── agents/                   # Agent definitions as .md files
│   ├── security-reviewer.md
│   └── compliance-checker.md
├── skills/                   # Agent Skills (folder-per-skill)
│   ├── code-review/
│   │   └── SKILL.md
│   └── pdf-processor/
│       ├── SKILL.md
│       └── scripts/
├── hooks/                    # Hook configurations
│   └── hooks.json            # Main hook config
├── .mcp.json                 # MCP server definitions
├── .lsp.json                 # LSP server configurations
├── scripts/                  # Hook and utility scripts
│   ├── format-code.py
│   └── deploy.js
├── README.md
├── LICENSE
└── CHANGELOG.md
```

**Critical rule**: NEVER put `commands/`, `agents/`, `skills/`, or `hooks/` inside `.claude-plugin/`. Only `plugin.json` goes there.

#### plugin.json Manifest Schema

```json
{
  "name": "plugin-name",           // REQUIRED: kebab-case, unique identifier & namespace
  "version": "1.2.0",             // Semantic versioning
  "description": "Brief description",
  "author": {
    "name": "Author Name",
    "email": "author@example.com",
    "url": "https://github.com/author"
  },
  "homepage": "https://docs.example.com/plugin",
  "repository": "https://github.com/author/plugin",
  "license": "MIT",
  "keywords": ["keyword1", "keyword2"],
  "commands": ["./custom/commands/special.md"],  // string or array
  "agents": "./custom/agents/",                  // string or array
  "skills": "./custom/skills/",                  // string or array
  "hooks": "./config/hooks.json",                // string, array, or inline object
  "mcpServers": "./mcp-config.json",             // string, array, or inline object
  "outputStyles": "./styles/",                   // string or array
  "lspServers": "./.lsp.json"                    // string, array, or inline object
}
```

**Field details**:
- `name` is the ONLY required field if you include a manifest
- The manifest itself is optional -- Claude Code auto-discovers components in default locations
- Custom paths SUPPLEMENT default directories, they do not replace them
- All paths must be relative to plugin root and start with `./`
- `${CLAUDE_PLUGIN_ROOT}` environment variable provides absolute path in hooks/scripts

---

### 2. Plugin Capabilities

Plugins can bundle ALL of these component types:

| Component | Location | Format |
|-----------|----------|--------|
| **Commands** | `commands/` | `.md` files (slash commands) |
| **Skills** | `skills/<name>/` | `SKILL.md` files (auto-invoked by Claude) |
| **Agents** | `agents/` | `.md` files with frontmatter |
| **Hooks** | `hooks/hooks.json` | JSON event handlers |
| **MCP Servers** | `.mcp.json` | Standard MCP config |
| **LSP Servers** | `.lsp.json` | Language server config |
| **Output Styles** | `outputStyles/` | Response formatting |
| **Scripts** | `scripts/` | Shell/Python/JS utilities |

#### Skills vs Commands

- **Skills** (`skills/`): Folder-per-skill with `SKILL.md`. Claude can auto-invoke based on context. Support progressive disclosure, tool restrictions, and reference files.
- **Commands** (`commands/`): Simple `.md` files. Become `/plugin-name:command-name`. Legacy approach; new plugins should prefer `skills/`.

#### Hook Configuration

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/format-code.sh"
          }
        ]
      }
    ]
  }
}
```

**Available hook events**: PreToolUse, PostToolUse, PostToolUseFailure, PermissionRequest, UserPromptSubmit, Notification, Stop, SubagentStart, SubagentStop, SessionStart, SessionEnd, TeammateIdle, TaskCompleted, PreCompact

**Hook types**: `command` (shell), `prompt` (LLM evaluation), `agent` (agentic verifier)

#### MCP Server Configuration

```json
{
  "mcpServers": {
    "plugin-database": {
      "command": "${CLAUDE_PLUGIN_ROOT}/servers/db-server",
      "args": ["--config", "${CLAUDE_PLUGIN_ROOT}/config.json"],
      "env": {
        "DB_PATH": "${CLAUDE_PLUGIN_ROOT}/data"
      }
    }
  }
}
```

---

### 3. Plugin Namespacing

- All plugin components are namespaced by the plugin's `name` field
- Commands: `/my-plugin:hello` (not `/hello`)
- Agents: `my-plugin:agent-name`
- This prevents conflicts when multiple plugins have same-named components
- The namespace prefix is controlled by the `name` field in `plugin.json`
- Standalone configs (in `.claude/`) use short names like `/hello`

---

### 4. Marketplace & Distribution

#### marketplace.json Schema

```json
{
  "$schema": "https://anthropic.com/claude-code/marketplace.schema.json",
  "name": "my-marketplace",         // REQUIRED: kebab-case identifier
  "description": "Marketplace description",
  "owner": {                         // REQUIRED
    "name": "Maintainer Name",
    "email": "contact@example.com"   // optional
  },
  "metadata": {
    "description": "Brief description",
    "version": "1.0.0",
    "pluginRoot": "./plugins"        // Base dir for relative plugin sources
  },
  "plugins": [                       // REQUIRED: array of plugin entries
    {
      "name": "my-plugin",          // REQUIRED
      "source": "./plugins/my-plugin", // REQUIRED: path, github, url, npm, pip
      "description": "What it does",
      "version": "1.0.0",
      "author": { "name": "Dev" },
      "homepage": "https://...",
      "repository": "https://...",
      "license": "MIT",
      "keywords": ["tag1", "tag2"],
      "category": "productivity",
      "tags": ["community-managed"],
      "strict": true                 // default true; false = marketplace entry defines everything
    }
  ]
}
```

#### Source Types

1. **Relative path**: `"source": "./plugins/my-plugin"` (local directory)
2. **GitHub**: `"source": { "source": "github", "repo": "owner/repo", "ref": "v2.0", "sha": "abc123..." }`
3. **Git URL**: `"source": { "source": "url", "url": "https://gitlab.com/team/plugin.git" }`
4. **npm**: Referenced in docs but "not yet fully implemented" -- use GitHub instead
5. **pip**: Referenced in docs but "not yet fully implemented" -- use GitHub instead

#### Reserved Marketplace Names

These are reserved for Anthropic: `claude-code-marketplace`, `claude-code-plugins`, `claude-plugins-official`, `anthropic-marketplace`, `anthropic-plugins`, `agent-skills`, `life-sciences`. Names impersonating official marketplaces are blocked.

#### Hosting Options

- **GitHub** (recommended): Push repo, users add with `owner/repo` format
- **GitLab/Bitbucket/self-hosted**: Full git URL
- **Local path**: For development and testing
- **Remote URL**: Direct link to marketplace.json (limited -- relative paths won't work)

---

### 5. Installation Flow

When a user runs `/plugin install plugin-name@marketplace-name`:

1. Claude Code locates the marketplace configuration
2. Finds the plugin entry in `marketplace.json`
3. Resolves the `source` field to locate plugin files
4. **Copies** the entire plugin directory to a local cache (`~/.claude/plugins/cache/`)
5. Reads `plugin.json` manifest (or auto-discovers components)
6. Registers commands, agents, skills in the appropriate scope
7. Starts any MCP servers defined in `.mcp.json`
8. Hooks are registered for their events

**Important caching behavior**:
- Plugins are COPIED to cache, not used in-place
- Files outside the plugin directory are NOT copied (no `../shared` references)
- Symlinks ARE followed during copy
- `${CLAUDE_PLUGIN_ROOT}` resolves to the cache location

#### Installation Scopes

| Scope | Settings File | Use Case |
|-------|---------------|----------|
| `user` | `~/.claude/settings.json` | Personal, all projects (default) |
| `project` | `.claude/settings.json` | Team, version-controlled |
| `local` | `.claude/settings.local.json` | Project-specific, gitignored |
| `managed` | `managed-settings.json` | Admin-controlled, read-only |

#### Team Distribution

Add to `.claude/settings.json` for auto-prompting:
```json
{
  "extraKnownMarketplaces": {
    "company-tools": {
      "source": { "source": "github", "repo": "your-org/claude-plugins" }
    }
  },
  "enabledPlugins": {
    "my-plugin@company-tools": true
  }
}
```

---

### 6. Plugin Settings/Configuration

Plugins do NOT have a dedicated settings system with schema-based configuration. User customization happens through:

1. **`.claude/settings.local.json`**: Personal, gitignored settings for the project
2. **`CLAUDE.local.md`**: Personal notes and preferences (not shared)
3. **Environment variables**: Plugins can read env vars in hooks/MCP servers
4. **Hook configuration**: Hooks can be overridden at different scopes

The `plugin-dev` toolkit references a "Plugin Settings" skill that uses `.local.md` files for configuration storage, but this appears to be a convention rather than a formal plugin settings API.

**Key implication**: If your plugin needs user configuration (API keys, preferences), the recommended approach is:
- Environment variables for secrets
- Instructions in README for users to set env vars
- A setup command/skill that guides configuration
- `.local.md` or `.local.json` conventions for plugin-specific settings

---

### 7. Official Marketplace Submission

To submit to `claude-plugins-official`:

1. **External plugins** go to `/external_plugins/` directory
2. Submit via the [plugin directory submission form](https://clau.de/plugin-directory-submission)
3. Must meet quality and security standards
4. Anthropic reviews but notes they "cannot verify plugins work as intended"
5. After approval, plugin appears in the official marketplace
6. Users can discover via `/plugin` > Discover tab

#### Review Criteria (Inferred)

- Valid plugin structure with working components
- Clear documentation (README)
- No security concerns (no hardcoded credentials, safe file operations)
- Useful/non-trivial functionality
- Proper licensing

---

### 8. Development Workflow

#### Testing

```bash
# Load plugin during development (no install needed)
claude --plugin-dir ./my-plugin

# Load multiple plugins
claude --plugin-dir ./plugin-one --plugin-dir ./plugin-two

# Debug plugin loading
claude --debug

# Validate plugin structure
claude plugin validate .
```

#### Plugin-Dev Toolkit (8-Phase Workflow)

The official `plugin-dev` plugin provides `/plugin-dev:create-plugin` with:

1. **Discovery** -- Understanding purpose and requirements
2. **Component Planning** -- Determining needed skills, commands, agents, hooks, MCP
3. **Detailed Design** -- Specifying each component, resolving ambiguities
4. **Structure Creation** -- Setting up directories and manifest
5. **Component Implementation** -- Creating each piece with AI assistance
6. **Validation** -- Running plugin-validator and component checks
7. **Testing** -- Verifying functionality in Claude Code
8. **Documentation** -- Finalizing README and preparing distribution

Includes 3 validation agents: `plugin-validator`, `skill-reviewer`, `agent-creator`

---

## Best Practices

1. **Structure**: Keep `.claude-plugin/` clean -- only `plugin.json` inside
2. **Paths**: Always use `${CLAUDE_PLUGIN_ROOT}` in hooks and MCP configs
3. **Naming**: Use kebab-case for plugin name, it becomes the namespace prefix
4. **Versioning**: Use semantic versioning, start at 1.0.0
5. **Scripts**: Make all hook scripts executable (`chmod +x`)
6. **MCP context**: Don't enable too many MCP servers -- 200k context can shrink to 70k
7. **Hook matchers**: Use specific matchers, not overly broad patterns
8. **Security**: Validate input in hooks, use env vars for credentials
9. **Documentation**: Include README with installation and usage
10. **Testing**: Use `--plugin-dir` during development, `claude --debug` for troubleshooting
11. **Migration path**: Start with standalone `.claude/` config, convert to plugin when sharing

---

## Common Pitfalls

1. Putting components inside `.claude-plugin/` instead of plugin root
2. Using absolute paths instead of relative paths with `./`
3. Forgetting to make hook scripts executable
4. Using `../` paths that won't work after cache copy
5. Not using `${CLAUDE_PLUGIN_ROOT}` in hook/MCP paths
6. Assuming npm/pip sources work (they're not fully implemented yet)
7. Using URL-based marketplaces with relative path sources (won't resolve)
8. Not restarting Claude Code after plugin changes during development

---

## Conflicting Information

- The plugin-dev toolkit mentions `.local.md` files for plugin settings, but the official docs don't document a formal plugin settings API. This appears to be a community convention, not an official feature.
- npm and pip source types are listed in documentation but flagged as "not yet fully implemented" in validation warnings. Use GitHub or git URL sources instead.
- Some blog posts reference a plugin launch date of "October 9, 2025" while the docs require version 1.0.33+ (released around that time).

---

## Knowledge Gaps

1. **Plugin settings API**: No formal system for plugins to declare user-configurable settings with schemas, defaults, and validation. This is a gap if AIfred needs user configuration.
2. **Plugin lifecycle hooks**: No documented way for plugins to run setup/teardown on install/uninstall.
3. **Inter-plugin dependencies**: No mechanism for one plugin to depend on another.
4. **Plugin size limits**: No documented limits on plugin size or number of components.
5. **Auto-update mechanics**: Plugin updates happen at startup but details on version comparison are sparse.
6. **Strict vs non-strict**: The `strict` field behavior when marketplace and plugin.json both define components needs careful testing.

---

## Recommendations for AIfred Plugin Packaging

### Mapping AIfred to Plugin Format

| AIfred Component | Plugin Location |
|------------------|-----------------|
| `.claude/commands/*.md` | `commands/*.md` |
| `.claude/agents/*.md` | `agents/*.md` |
| `.claude/skills/*/SKILL.md` | `skills/*/SKILL.md` |
| `.claude/hooks/*.js` | `hooks/hooks.json` + `scripts/*.js` |
| MCP server configs | `.mcp.json` |
| CLAUDE.md instructions | `skills/` or commands with detailed prompts |
| Scripts/ | `scripts/` |

### Suggested Plugin Name

`aifred` -- yields commands like `/aifred:check-health`, `/aifred:deploy`, etc.

### Distribution Strategy

1. Create a GitHub repo: `davidmoneil/aifred-plugin`
2. Include `marketplace.json` in the repo root for self-hosted marketplace
3. Submit to `claude-plugins-official` via the submission form for broader reach
4. For team use, configure `extraKnownMarketplaces` in project settings

### Next Steps

1. Install the `plugin-dev` plugin: `/plugin install plugin-dev@claude-plugins-official`
2. Run `/plugin-dev:create-plugin` with AIfred description
3. Migrate existing `.claude/` configurations to plugin format
4. Test with `claude --plugin-dir ./aifred-plugin`
5. Create marketplace.json and GitHub repo
6. Submit to official marketplace

---

## Sources

1. [Create plugins - Claude Code Docs](https://code.claude.com/docs/en/plugins) - Official plugin creation guide (High credibility)
2. [Plugins reference - Claude Code Docs](https://code.claude.com/docs/en/plugins-reference) - Complete technical reference (High credibility)
3. [Create and distribute a plugin marketplace - Claude Code Docs](https://code.claude.com/docs/en/plugin-marketplaces) - Marketplace creation guide (High credibility)
4. [Discover and install plugins - Claude Code Docs](https://code.claude.com/docs/en/discover-plugins) - Installation flow documentation (High credibility)
5. [anthropics/claude-plugins-official - GitHub](https://github.com/anthropics/claude-plugins-official) - Official plugin repository (High credibility)
6. [anthropics/claude-code plugins/ - GitHub](https://github.com/anthropics/claude-code/blob/main/plugins/README.md) - Demo plugins and README (High credibility)
7. [anthropics/claude-code marketplace.json - GitHub](https://github.com/anthropics/claude-code/blob/main/.claude-plugin/marketplace.json) - Demo marketplace format (High credibility)
8. [claude-plugins-official marketplace.json - GitHub](https://github.com/anthropics/claude-plugins-official/blob/main/.claude-plugin/marketplace.json) - Official marketplace format (High credibility)
9. [sjnims/plugin-dev - GitHub](https://github.com/sjnims/plugin-dev) - Plugin development toolkit (Medium credibility)
10. [Composio Blog - Claude Code Plugins](https://composio.dev/blog/claude-code-plugin) - Community guide (Medium credibility)
11. [Firecrawl Blog - Top 10 Claude Code Plugins](https://www.firecrawl.dev/blog/best-claude-code-plugins) - Plugin overview (Medium credibility)
12. [Claude Code Settings - Official Docs](https://code.claude.com/docs/en/settings) - Settings reference (High credibility)

---

## Related Topics

- Claude Code Agent SDK (for building standalone agents vs plugins)
- MCP Server development (for custom tool integrations)
- Claude Code hooks system (deep dive into event handling)
- Plugin monetization and licensing strategies
- Multi-plugin orchestration patterns
